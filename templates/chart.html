<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–Ü—Å—Ç–æ—Ä–∏—á–Ω–∏–π —Å–ø—Ä–µ–¥ - –î—ñ–∞–≥—Ä–∞–º–∞</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .status-indicators {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status.online {
            background: #d4edda;
            color: #155724;
        }
        
        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .current-values {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .value-box {
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            min-width: 120px;
        }
        
        .value-box.in {
            background: #d1f2eb;
            color: #0e6655;
            border-left: 4px solid #1abc9c;
        }
        
        .value-box.out {
            background: #fadbd8;
            color: #922b21;
            border-left: 4px solid #e74c3c;
        }
        
        .value-label {
            font-size: 12px;
            font-weight: 400;
            opacity: 0.8;
            margin-bottom: 4px;
        }
        
        .value-number {
            font-size: 20px;
        }
        
        #chart {
            width: 100%;
            height: 600px;
            margin-top: 20px;
        }
        
        .info {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
            font-size: 14px;
            color: #0d47a1;
        }
        
        .info strong {
            display: block;
            margin-bottom: 5px;
        }
        
        .analysis-results {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .analysis-results h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .method-section {
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .method-section h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .method-section .method-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            border-radius: 3px;
        }
        
        .method-section.histogram .method-icon {
            background: #3498db;
        }
        
        .method-section.mode .method-icon {
            background: #e67e22;
        }
        
        .method-section.kde .method-icon {
            background: #9b59b6;
        }
        
        .method-section.clustering .method-icon {
            background: #27ae60;
        }
        
        .method-section.quantiles .method-icon {
            background: #8b4513;
        }
        
        .result-item {
            margin: 8px 0;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .result-item strong {
            color: #555;
            margin-right: 8px;
        }
        
        .result-item .value {
            color: #333;
            font-weight: 600;
        }
        
        .result-list {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }
        
        .result-list li {
            padding: 6px 10px;
            margin: 4px 0;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .new-request-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-block;
            font-size: 14px;
        }
        
        .new-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-row h1 {
            margin: 0;
        }
        
        .settings-panel {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .settings-panel h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .settings-group {
            display: flex;
            flex-direction: column;
        }
        
        .settings-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
        }
        
        .settings-group input[type="number"],
        .settings-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .settings-group input[type="number"]:focus,
        .settings-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .settings-checkboxes {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .settings-checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .settings-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .settings-checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-size: 13px;
        }
        
        .update-btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        
        .update-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .update-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 10px;
            color: #667eea;
            font-weight: 500;
        }
        
        .loading-indicator.show {
            display: block;
        }
        
        @media (max-width: 640px) {
            .header-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .new-request-btn {
                width: 100%;
                text-align: center;
            }
        }

        /* Lookback (2/4/8/16 –≥–æ–¥) */
        .lookback-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .lookback-card {
            background: white;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .lookback-card h3 {
            margin: 0 0 10px 0;
            color: #0d47a1;
            font-size: 16px;
        }

        .lookback-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }

        .lookback-table th,
        .lookback-table td {
            border: 1px solid #e0e0e0;
            padding: 6px 8px;
            text-align: center;
            vertical-align: middle;
        }

        .lookback-table th {
            background: #f5f7fa;
            color: #333;
            font-weight: 600;
        }

        .lookback-row-label {
            text-align: left;
            font-weight: 700;
            white-space: nowrap;
        }

        .yn-yes {
            color: #155724;
            background: #d4edda;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }

        .yn-no {
            color: #721c24;
            background: #f8d7da;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>–Ü—Å—Ç–æ—Ä–∏—á–Ω–∏–π —Å–ø—Ä–µ–¥ - –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è</h1>
            <a href="/" class="new-request-btn">üîÑ –ù–æ–≤–∏–π –∑–∞–ø–∏—Ç</a>
        </div>
        
        <div class="settings-panel">
            <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–Ω–∞–ª—ñ–∑—É</h2>
            <div class="settings-form" id="settingsForm">
                <div class="settings-group">
                    <label for="settings_limit">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫</label>
                    <input 
                        type="number" 
                        id="settings_limit" 
                        value="{{ limit|default(10000) }}"
                        min="1"
                        max="10000"
                    >
                </div>
                
                <div class="settings-group">
                    <label for="settings_tolerance">–¢–æ–ª–µ—Ä–∞–Ω—Ç–Ω—ñ—Å—Ç—å</label>
                    <input 
                        type="number" 
                        id="settings_tolerance" 
                        value="{{ tolerance|default(0.01) }}"
                        step="0.001"
                        min="0"
                    >
                </div>
                
                <div class="settings-group">
                    <label for="settings_avg_method">–ú–µ—Ç–æ–¥ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ</label>
                    <select id="settings_avg_method">
                        <option value="simple" {% if avg_method|default('methods') == 'simple' %}selected{% endif %}>–ü—Ä–æ—Å—Ç–µ —Å–µ—Ä–µ–¥–Ω—î –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–Ω–µ</option>
                        <option value="methods" {% if avg_method|default('methods') == 'methods' %}selected{% endif %}>–°–µ—Ä–µ–¥–Ω—î –∑ –º–µ—Ç–æ–¥–∏–∫</option>
                        <option value="both" {% if avg_method|default('methods') == 'both' %}selected{% endif %}>–û–±–∏–¥–≤–∞</option>
                    </select>
                </div>
                
                <div class="settings-checkboxes">
                    <div class="settings-checkbox-item">
                        <input type="checkbox" id="settings_use_histogram" {% if use_histogram|default('true') == 'true' %}checked{% endif %}>
                        <label for="settings_use_histogram">–ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞</label>
                    </div>
                    <div class="settings-checkbox-item">
                        <input type="checkbox" id="settings_use_mode" {% if use_mode|default('true') == 'true' %}checked{% endif %}>
                        <label for="settings_use_mode">–ú–æ–¥–∞</label>
                    </div>
                    <div class="settings-checkbox-item">
                        <input type="checkbox" id="settings_use_kde" {% if use_kde|default('true') == 'true' %}checked{% endif %}>
                        <label for="settings_use_kde">KDE (–Ω–∞–π–≤–∏—â–∏–π –ø—ñ–∫)</label>
                    </div>
                    <div class="settings-checkbox-item">
                        <input type="checkbox" id="settings_use_clustering" {% if use_clustering|default('true') == 'true' %}checked{% endif %}>
                        <label for="settings_use_clustering">–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—è</label>
                    </div>
                    <div class="settings-checkbox-item">
                        <input type="checkbox" id="settings_use_quantiles" {% if use_quantiles|default('true') == 'true' %}checked{% endif %}>
                        <label for="settings_use_quantiles">–ö–≤–∞–Ω—Ç–∏–ª—ñ (–º–µ–¥—ñ–∞–Ω–∞)</label>
                    </div>
                </div>
            </div>
            <button class="update-btn" id="updateBtn">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
            <div class="loading-indicator" id="loadingIndicator">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
        
        <div class="status-indicators">
            {% if left_status %}
            <div class="status {{ 'online' if left_status == 'online' else 'offline' }}">
                {{ left_exchange }}: {{ left_status }}
            </div>
            {% endif %}
            {% if right_status %}
            <div class="status {{ 'online' if right_status == 'online' else 'offline' }}">
                {{ right_exchange }}: {{ right_status }}
            </div>
            {% endif %}
        </div>
        
        <div class="current-values">
            {% if current_in is not none %}
            <div class="value-box in">
                <div class="value-label">In</div>
                <div class="value-number">{{ "%.2f"|format(current_in) }}</div>
            </div>
            {% endif %}
            {% if current_out is not none %}
            <div class="value-box out">
                <div class="value-label">Out</div>
                <div class="value-number">{{ "%.2f"|format(current_out) }}</div>
            </div>
            {% endif %}
        </div>
        
        <div id="chart"></div>
        
        <div class="info">
            <strong>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</strong>
            –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫: {{ total_points }} | 
            –î—ñ–∞–ø–∞–∑–æ–Ω: {{ time_range }}
            {% if error %}
            <br><span style="color: #d32f2f; font-weight: bold;">–ü–æ–º–∏–ª–∫–∞: {{ error }}</span>
            {% endif %}
        </div>

        <div class="analysis-results" id="lookbackSection">
            <h2>‚è± –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ö–æ–¥–∂–µ–Ω–Ω—è –¥–æ 0/–ø–æ—Ä–æ–≥—ñ–≤ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 2/4/8/16 –≥–æ–¥</h2>

            <div id="lookbackContainer">
                {% if lookback_checks and lookback_checks.windows and lookback_checks.hours %}
                <div class="lookback-grid">
                    {% for hours in lookback_checks.hours %}
                        {% set win = lookback_checks.windows[hours ~ ''] %}
                        {% if win %}
                        <div class="lookback-card">
                            <h3>–û—Å—Ç–∞–Ω–Ω—ñ {{ hours }} –≥–æ–¥</h3>
                            <div class="result-item">
                                <strong>–ü–µ—Ä—ñ–æ–¥:</strong>
                                <span class="value">{{ win.start_time }} ‚Äì {{ win.end_time }}</span>
                                <span style="color:#666;">({{ win.points }} —Ç–æ—á–æ–∫)</span>
                            </div>

                            <table class="lookback-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>min</th>
                                        <th>max</th>
                                        <th>avg</th>
                                        <th>crossed 0</th>
                                        {% if lookback_checks.abs_thresholds %}
                                            {% for th in lookback_checks.abs_thresholds %}
                                            <th>|x| ‚â§ {{ th }}</th>
                                            {% endfor %}
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="lookback-row-label">In</td>
                                        <td>{{ "%.4f"|format(win.in.stats.min) if win.in.stats.min is not none else "‚Äî" }}</td>
                                        <td>{{ "%.4f"|format(win.in.stats.max) if win.in.stats.max is not none else "‚Äî" }}</td>
                                        <td>{{ "%.4f"|format(win.in.stats.avg) if win.in.stats.avg is not none else "‚Äî" }}</td>
                                        <td>
                                            <span class="{{ 'yn-yes' if win.in.crossed_zero else 'yn-no' }}">
                                                {{ '—Ç–∞–∫' if win.in.crossed_zero else '–Ω—ñ' }}
                                            </span>
                                        </td>
                                        {% if lookback_checks.abs_thresholds %}
                                            {% for th in lookback_checks.abs_thresholds %}
                                            {% set reached = win.in.reached_abs[th ~ ''] %}
                                            <td>
                                                <span class="{{ 'yn-yes' if reached else 'yn-no' }}">
                                                    {{ '—Ç–∞–∫' if reached else '–Ω—ñ' }}
                                                </span>
                                            </td>
                                            {% endfor %}
                                        {% endif %}
                                    </tr>
                                    <tr>
                                        <td class="lookback-row-label">Out</td>
                                        <td>{{ "%.4f"|format(win.out.stats.min) if win.out.stats.min is not none else "‚Äî" }}</td>
                                        <td>{{ "%.4f"|format(win.out.stats.max) if win.out.stats.max is not none else "‚Äî" }}</td>
                                        <td>{{ "%.4f"|format(win.out.stats.avg) if win.out.stats.avg is not none else "‚Äî" }}</td>
                                        <td>
                                            <span class="{{ 'yn-yes' if win.out.crossed_zero else 'yn-no' }}">
                                                {{ '—Ç–∞–∫' if win.out.crossed_zero else '–Ω—ñ' }}
                                            </span>
                                        </td>
                                        {% if lookback_checks.abs_thresholds %}
                                            {% for th in lookback_checks.abs_thresholds %}
                                            {% set reached = win.out.reached_abs[th ~ ''] %}
                                            <td>
                                                <span class="{{ 'yn-yes' if reached else 'yn-no' }}">
                                                    {{ '—Ç–∞–∫' if reached else '–Ω—ñ' }}
                                                </span>
                                            </td>
                                            {% endfor %}
                                        {% endif %}
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="method-section" style="border-left-color: #999;">
                    <p style="color: #666; margin: 0;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–∞ —á–∞—Å–æ–≤–∏–º–∏ –≤—ñ–∫–Ω–∞–º–∏.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="analysis-results" id="inAnalysisSection">
            <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑—É –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –∑–Ω–∞—á–µ–Ω—å —Å–ø—Ä–µ–¥—É –≤—Ö–æ–¥—É (In)</h2>

            {% if not in_analysis or (not in_analysis.histogram.most_frequent_bin and in_analysis["mode"]["value"] is none and (not in_analysis.kde.peaks or in_analysis.kde.peaks|length == 0) and (not in_analysis.clustering.clusters or in_analysis.clustering.clusters|length == 0) and in_analysis.quantiles.median is none) %}
            <div class="method-section" style="border-left-color: #999;">
                <p style="color: #666; margin: 0;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –∞–±–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–æ—á–æ–∫ –¥–ª—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>
            </div>
            {% else %}

            <!-- –°–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è -->
            {% if average_in_from_methods and average_in_from_methods.average is not none %}
            <div class="method-section" style="border-left-color: #667eea; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-left-width: 5px;">
                <h3 style="color: #667eea; font-size: 18px;">
                    ‚≠ê –°–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è
                    {% if average_in_from_methods.method_names|length == 1 and "–ü—Ä–æ—Å—Ç–µ —Å–µ—Ä–µ–¥–Ω—î" in average_in_from_methods.method_names[0] %}
                        (–ø—Ä–æ—Å—Ç–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–Ω–µ)
                    {% elif "–ü—Ä–æ—Å—Ç–µ —Å–µ—Ä–µ–¥–Ω—î" in average_in_from_methods.method_names|join("") %}
                        (–∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–µ)
                    {% else %}
                        (–∑ –º–µ—Ç–æ–¥–∏–∫)
                    {% endif %}
                </h3>
                <div class="result-item" style="background: white; padding: 15px; border-radius: 6px; margin: 10px 0;">
                    <div id="avg_in_value" style="font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 10px;">
                        {{ "%.4f"|format(average_in_from_methods.average) }}
                    </div>
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º–µ—Ç–æ–¥–∏–∫, —â–æ –≤—Ä–∞—Ö–æ–≤–∞–Ω–æ:</strong>
                        <span class="value" id="avg_in_count">{{ average_in_from_methods.count }}</span>
                    </div>
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–ú–µ—Ç–æ–¥–∏–∫–∏:</strong>
                        <span class="value" id="avg_in_methods">{{ average_in_from_methods.method_names|join(", ") }}</span>
                    </div>
                    {% if average_in_from_methods["values"]|length > 0 %}
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–ó–Ω–∞—á–µ–Ω–Ω—è –∑ –∫–æ–∂–Ω–æ—ó –º–µ—Ç–æ–¥–∏–∫–∏:</strong>
                        <ul class="result-list" id="avg_in_values_list" style="margin-top: 8px;">
                            {% for i in range(average_in_from_methods["values"]|length) %}
                            <li>
                                <strong>{{ average_in_from_methods.method_names[i] }}:</strong> 
                                <span class="value">{{ "%.4f"|format(average_in_from_methods["values"][i]) }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if average_in_from_methods.min is not none and average_in_from_methods.max is not none %}
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–î—ñ–∞–ø–∞–∑–æ–Ω –∑–Ω–∞—á–µ–Ω—å:</strong>
                        <span class="value" id="avg_in_range">[{{ "%.4f"|format(average_in_from_methods.min) }}, {{ "%.4f"|format(average_in_from_methods.max) }}]</span>
                    </div>
                    {% endif %}
                    {% if average_in_from_methods.std is not none and average_in_from_methods.std > 0 %}
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è:</strong>
                        <span class="value" id="avg_in_std">{{ "%.4f"|format(average_in_from_methods.std) }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ -->
            {% if in_analysis.histogram.most_frequent_bin %}
            <div class="method-section histogram">
                <h3>
                    <span class="method-icon"></span>
                    –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ (–±—ñ–Ω—ñ–Ω–≥)
                </h3>
                <div class="result-item">
                    <strong>–ù–∞–π—á–∞—Å—Ç—ñ—à–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω:</strong>
                    <span class="value">{{ "%.4f"|format(in_analysis.histogram.most_frequent_bin[0]) }} - {{ "%.4f"|format(in_analysis.histogram.most_frequent_bin[1]) }}</span>
                </div>
                <div class="result-item">
                    <strong>–¶–µ–Ω—Ç—Ä –¥—ñ–∞–ø–∞–∑–æ–Ω—É:</strong>
                    <span class="value">{{ "%.4f"|format((in_analysis.histogram.most_frequent_bin[0] + in_analysis.histogram.most_frequent_bin[1]) / 2) }}</span>
                </div>
                <div class="result-item">
                    <strong>–ß–∞—Å—Ç–æ—Ç–∞ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫):</strong>
                    <span class="value">{{ in_analysis.histogram.frequency }}</span>
                </div>
                {% if in_analysis.histogram.bin_edges and in_analysis.histogram.bin_edges|length > 1 %}
                <div class="result-item">
                    <strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –±—ñ–Ω—ñ–≤:</strong>
                    <span class="value">{{ in_analysis.histogram.bin_edges|length - 1 }}</span>
                </div>
                {% endif %}
                {% if in_analysis.histogram.top_bins and in_analysis.histogram.top_bins|length > 0 %}
                <div class="result-item">
                    <strong>–¢–æ–ø-5 –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ–≤:</strong>
                    <ul class="result-list">
                        {% for bin_info in in_analysis.histogram.top_bins %}
                        <li>
                            <strong>#{{ loop.index }}:</strong>
                            –î—ñ–∞–ø–∞–∑–æ–Ω = [{{ "%.4f"|format(bin_info.bin[0]) }}, {{ "%.4f"|format(bin_info.bin[1]) }}],
                            –¶–µ–Ω—Ç—Ä = <span class="value">{{ "%.4f"|format(bin_info.center) }}</span>,
                            –ß–∞—Å—Ç–æ—Ç–∞ = {{ bin_info.frequency }} ({{ "%.2f"|format((bin_info.frequency / total_points * 100) if total_points > 0 else 0) }}%)
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- –ú–æ–¥–∞ -->
            {% if in_analysis["mode"]["value"] is not none %}
            <div class="method-section mode">
                <h3>
                    <span class="method-icon"></span>
                    –ú–æ–¥–∞ (–Ω–∞–π—á–∞—Å—Ç—ñ—à–µ —Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è)
                </h3>
                <div class="result-item">
                    <strong>–ó–Ω–∞—á–µ–Ω–Ω—è –º–æ–¥–∏:</strong>
                    <span class="value">{{ "%.4f"|format(in_analysis["mode"]["value"]) }}</span>
                </div>
                <div class="result-item">
                    <strong>–ß–∞—Å—Ç–æ—Ç–∞ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤—Ö–æ–¥–∂–µ–Ω—å):</strong>
                    <span class="value">{{ in_analysis["mode"]["frequency"] }}</span>
                </div>
                <div class="result-item">
                    <strong>–í—ñ–¥—Å–æ—Ç–æ–∫ –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ:</strong>
                    <span class="value">{{ "%.2f"|format((in_analysis["mode"]["frequency"] / total_points * 100) if total_points > 0 else 0) }}%</span>
                </div>
            </div>
            {% endif %}

            <!-- KDE -->
            {% if in_analysis.kde.peaks and in_analysis.kde.peaks|length > 0 %}
            <div class="method-section kde">
                <h3>
                    <span class="method-icon"></span>
                    KDE (Kernel Density Estimation) - –ü—ñ–∫–∏ —â—ñ–ª—å–Ω–æ—Å—Ç—ñ
                </h3>
                <div class="result-item">
                    <strong>–ó–Ω–∞–π–¥–µ–Ω–æ –ø—ñ–∫—ñ–≤:</strong>
                    <span class="value">{{ in_analysis.kde.peaks|length }}</span>
                </div>
                <div class="result-item">
                    <strong>–¢–æ–ø –ø—ñ–∫–∏ (–Ω–∞–π–≤–∏—â—ñ –∑–Ω–∞—á–µ–Ω–Ω—è —â—ñ–ª—å–Ω–æ—Å—Ç—ñ):</strong>
                    <ul class="result-list">
                        {% for peak in in_analysis.kde.peaks %}
                        <li>
                            <strong>–ü—ñ–∫ {{ loop.index }}:</strong> 
                            –ó–Ω–∞—á–µ–Ω–Ω—è = <span class="value">{{ "%.4f"|format(peak) }}</span>
                            {% if in_analysis.kde.peak_values and loop.index0 < in_analysis.kde.peak_values|length %}
                            , –©—ñ–ª—å–Ω—ñ—Å—Ç—å = {{ "%.4f"|format(in_analysis.kde.peak_values[loop.index0]) }}
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—è -->
            {% if in_analysis.clustering.clusters and in_analysis.clustering.clusters|length > 0 %}
            <div class="method-section clustering">
                <h3>
                    <span class="method-icon"></span>
                    –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—è ({{ in_analysis.clustering.method|upper if in_analysis.clustering.method else "K-means" }})
                </h3>
                <div class="result-item">
                    <strong>–ó–Ω–∞–π–¥–µ–Ω–æ –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤:</strong>
                    <span class="value">{{ in_analysis.clustering.clusters|length }}</span>
                </div>
                <div class="result-item">
                    <strong>–î–µ—Ç–∞–ª—ñ –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤ (–≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω—ñ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç–æ—á–æ–∫):</strong>
                    <ul class="result-list">
                        {% for cluster in in_analysis.clustering.clusters %}
                        <li>
                            <strong>–ö–ª–∞—Å—Ç–µ—Ä {{ loop.index }}:</strong>
                            –¶–µ–Ω—Ç—Ä = <span class="value">{{ "%.4f"|format(cluster.center) }}</span>,
                            –î—ñ–∞–ø–∞–∑–æ–Ω = [{{ "%.4f"|format(cluster.range[0]) }}, {{ "%.4f"|format(cluster.range[1]) }}],
                            –¢–æ—á–æ–∫ = {{ cluster.points }} ({{ "%.2f"|format((cluster.points / total_points * 100) if total_points > 0 else 0) }}%)
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- –ö–≤–∞–Ω—Ç–∏–ª—ñ -->
            {% if in_analysis.quantiles.median is not none %}
            <div class="method-section quantiles">
                <h3>
                    <span class="method-icon"></span>
                    –ö–≤–∞–Ω—Ç–∏–ª—ñ —Ç–∞ –º–µ–¥—ñ–∞–Ω–∞
                </h3>
                <div class="result-item">
                    <strong>–ú–µ–¥—ñ–∞–Ω–∞ (Q2, 50-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å):</strong>
                    <span class="value">{{ "%.4f"|format(in_analysis.quantiles.median) }}</span>
                </div>
                <div class="result-item">
                    <strong>Q1 (25-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å):</strong>
                    <span class="value">{{ "%.4f"|format(in_analysis.quantiles.q1) }}</span>
                </div>
                <div class="result-item">
                    <strong>Q3 (75-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å):</strong>
                    <span class="value">{{ "%.4f"|format(in_analysis.quantiles.q3) }}</span>
                </div>
                <div class="result-item">
                    <strong>–Ü–Ω—Ç–µ—Ä–∫–≤–∞—Ä—Ç–∏–ª—å–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω (IQR = Q3 - Q1):</strong>
                    <span class="value">{{ "%.4f"|format(in_analysis.quantiles.iqr) }}</span>
                </div>
                <div class="result-item">
                    <strong>–î—ñ–∞–ø–∞–∑–æ–Ω Q1-Q3:</strong>
                    <span class="value">[{{ "%.4f"|format(in_analysis.quantiles.q1) }}, {{ "%.4f"|format(in_analysis.quantiles.q3) }}]</span>
                    <br><small style="color: #666;">–¶–µ –¥—ñ–∞–ø–∞–∑–æ–Ω, –≤ —è–∫–æ–º—É –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è 50% –≤—Å—ñ—Ö –∑–Ω–∞—á–µ–Ω—å</small>
                </div>
            </div>
            {% endif %}

            {% endif %}
        </div>
        
        <div class="analysis-results">
            <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑—É –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –∑–Ω–∞—á–µ–Ω—å —Å–ø—Ä–µ–¥—É –≤–∏—Ö–æ–¥—É (Out)</h2>
            
            {% if not out_analysis or (not out_analysis.histogram.most_frequent_bin and out_analysis["mode"]["value"] is none and (not out_analysis.kde.peaks or out_analysis.kde.peaks|length == 0) and (not out_analysis.clustering.clusters or out_analysis.clustering.clusters|length == 0) and out_analysis.quantiles.median is none) %}
            <div class="method-section" style="border-left-color: #999;">
                <p style="color: #666; margin: 0;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –∞–±–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–æ—á–æ–∫ –¥–ª—è –æ–±—á–∏—Å–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>
            </div>
            {% else %}
            
            <!-- –°–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è -->
            {% if average_from_methods and average_from_methods.average is not none %}
            <div class="method-section" style="border-left-color: #667eea; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-left-width: 5px;">
                <h3 style="color: #667eea; font-size: 18px;">
                    ‚≠ê –°–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è
                    {% if average_from_methods.method_names|length == 1 and "–ü—Ä–æ—Å—Ç–µ —Å–µ—Ä–µ–¥–Ω—î" in average_from_methods.method_names[0] %}
                        (–ø—Ä–æ—Å—Ç–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–Ω–µ)
                    {% elif "–ü—Ä–æ—Å—Ç–µ —Å–µ—Ä–µ–¥–Ω—î" in average_from_methods.method_names|join("") %}
                        (–∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–µ)
                    {% else %}
                        (–∑ –º–µ—Ç–æ–¥–∏–∫)
                    {% endif %}
                </h3>
                <div class="result-item" style="background: white; padding: 15px; border-radius: 6px; margin: 10px 0;">
                    <div id="avg_out_value" style="font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 10px;">
                        {{ "%.4f"|format(average_from_methods.average) }}
                    </div>
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º–µ—Ç–æ–¥–∏–∫, —â–æ –≤—Ä–∞—Ö–æ–≤–∞–Ω–æ:</strong>
                        <span class="value" id="avg_out_count">{{ average_from_methods.count }}</span>
                    </div>
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–ú–µ—Ç–æ–¥–∏–∫–∏:</strong>
                        <span class="value" id="avg_out_methods">{{ average_from_methods.method_names|join(", ") }}</span>
                    </div>
                    {% if average_from_methods["values"]|length > 0 %}
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–ó–Ω–∞—á–µ–Ω–Ω—è –∑ –∫–æ–∂–Ω–æ—ó –º–µ—Ç–æ–¥–∏–∫–∏:</strong>
                        <ul class="result-list" id="avg_out_values_list" style="margin-top: 8px;">
                            {% for i in range(average_from_methods["values"]|length) %}
                            <li>
                                <strong>{{ average_from_methods.method_names[i] }}:</strong> 
                                <span class="value">{{ "%.4f"|format(average_from_methods["values"][i]) }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% if average_from_methods.min is not none and average_from_methods.max is not none %}
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–î—ñ–∞–ø–∞–∑–æ–Ω –∑–Ω–∞—á–µ–Ω—å:</strong>
                        <span class="value" id="avg_out_range">[{{ "%.4f"|format(average_from_methods.min) }}, {{ "%.4f"|format(average_from_methods.max) }}]</span>
                    </div>
                    {% endif %}
                    {% if average_from_methods.std is not none and average_from_methods.std > 0 %}
                    <div class="result-item" style="background: transparent; padding: 5px 0;">
                        <strong>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è:</strong>
                        <span class="value" id="avg_out_std">{{ "%.4f"|format(average_from_methods.std) }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endif %}
            
            <!-- –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ -->
            {% if out_analysis.histogram.most_frequent_bin %}
            <div class="method-section histogram">
                <h3>
                    <span class="method-icon"></span>
                    –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ (–±—ñ–Ω—ñ–Ω–≥)
                </h3>
                <div class="result-item">
                    <strong>–ù–∞–π—á–∞—Å—Ç—ñ—à–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω:</strong>
                    <span class="value">{{ "%.4f"|format(out_analysis.histogram.most_frequent_bin[0]) }} - {{ "%.4f"|format(out_analysis.histogram.most_frequent_bin[1]) }}</span>
                </div>
                <div class="result-item">
                    <strong>–¶–µ–Ω—Ç—Ä –¥—ñ–∞–ø–∞–∑–æ–Ω—É:</strong>
                    <span class="value">{{ "%.4f"|format((out_analysis.histogram.most_frequent_bin[0] + out_analysis.histogram.most_frequent_bin[1]) / 2) }}</span>
                </div>
                <div class="result-item">
                    <strong>–ß–∞—Å—Ç–æ—Ç–∞ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫):</strong>
                    <span class="value">{{ out_analysis.histogram.frequency }}</span>
                </div>
                {% if out_analysis.histogram.bin_edges and out_analysis.histogram.bin_edges|length > 1 %}
                <div class="result-item">
                    <strong>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –±—ñ–Ω—ñ–≤:</strong>
                    <span class="value">{{ out_analysis.histogram.bin_edges|length - 1 }}</span>
                </div>
                {% endif %}
                {% if out_analysis.histogram.top_bins and out_analysis.histogram.top_bins|length > 0 %}
                <div class="result-item">
                    <strong>–¢–æ–ø-5 –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ–≤:</strong>
                    <ul class="result-list">
                        {% for bin_info in out_analysis.histogram.top_bins %}
                        <li>
                            <strong>#{{ loop.index }}:</strong>
                            –î—ñ–∞–ø–∞–∑–æ–Ω = [{{ "%.4f"|format(bin_info.bin[0]) }}, {{ "%.4f"|format(bin_info.bin[1]) }}],
                            –¶–µ–Ω—Ç—Ä = <span class="value">{{ "%.4f"|format(bin_info.center) }}</span>,
                            –ß–∞—Å—Ç–æ—Ç–∞ = {{ bin_info.frequency }} ({{ "%.2f"|format((bin_info.frequency / total_points * 100) if total_points > 0 else 0) }}%)
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- –ú–æ–¥–∞ -->
            {% if out_analysis["mode"]["value"] is not none %}
            <div class="method-section mode">
                <h3>
                    <span class="method-icon"></span>
                    –ú–æ–¥–∞ (–Ω–∞–π—á–∞—Å—Ç—ñ—à–µ —Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è)
                </h3>
                <div class="result-item">
                    <strong>–ó–Ω–∞—á–µ–Ω–Ω—è –º–æ–¥–∏:</strong>
                    <span class="value">{{ "%.4f"|format(out_analysis["mode"]["value"]) }}</span>
                </div>
                <div class="result-item">
                    <strong>–ß–∞—Å—Ç–æ—Ç–∞ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤—Ö–æ–¥–∂–µ–Ω—å):</strong>
                    <span class="value">{{ out_analysis["mode"]["frequency"] }}</span>
                </div>
                <div class="result-item">
                    <strong>–í—ñ–¥—Å–æ—Ç–æ–∫ –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ:</strong>
                    <span class="value">{{ "%.2f"|format((out_analysis["mode"]["frequency"] / total_points * 100) if total_points > 0 else 0) }}%</span>
                </div>
            </div>
            {% endif %}
            
            <!-- KDE -->
            {% if out_analysis.kde.peaks and out_analysis.kde.peaks|length > 0 %}
            <div class="method-section kde">
                <h3>
                    <span class="method-icon"></span>
                    KDE (Kernel Density Estimation) - –ü—ñ–∫–∏ —â—ñ–ª—å–Ω–æ—Å—Ç—ñ
                </h3>
                <div class="result-item">
                    <strong>–ó–Ω–∞–π–¥–µ–Ω–æ –ø—ñ–∫—ñ–≤:</strong>
                    <span class="value">{{ out_analysis.kde.peaks|length }}</span>
                </div>
                <div class="result-item">
                    <strong>–¢–æ–ø –ø—ñ–∫–∏ (–Ω–∞–π–≤–∏—â—ñ –∑–Ω–∞—á–µ–Ω–Ω—è —â—ñ–ª—å–Ω–æ—Å—Ç—ñ):</strong>
                    <ul class="result-list">
                        {% for peak in out_analysis.kde.peaks %}
                        <li>
                            <strong>–ü—ñ–∫ {{ loop.index }}:</strong> 
                            –ó–Ω–∞—á–µ–Ω–Ω—è = <span class="value">{{ "%.4f"|format(peak) }}</span>
                            {% if out_analysis.kde.peak_values and loop.index0 < out_analysis.kde.peak_values|length %}
                            , –©—ñ–ª—å–Ω—ñ—Å—Ç—å = {{ "%.4f"|format(out_analysis.kde.peak_values[loop.index0]) }}
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
            
            <!-- –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—è -->
            {% if out_analysis.clustering.clusters and out_analysis.clustering.clusters|length > 0 %}
            <div class="method-section clustering">
                <h3>
                    <span class="method-icon"></span>
                    –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—è ({{ out_analysis.clustering.method|upper if out_analysis.clustering.method else "K-means" }})
                </h3>
                <div class="result-item">
                    <strong>–ó–Ω–∞–π–¥–µ–Ω–æ –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤:</strong>
                    <span class="value">{{ out_analysis.clustering.clusters|length }}</span>
                </div>
                <div class="result-item">
                    <strong>–î–µ—Ç–∞–ª—ñ –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤ (–≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω—ñ –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —Ç–æ—á–æ–∫):</strong>
                    <ul class="result-list">
                        {% for cluster in out_analysis.clustering.clusters %}
                        <li>
                            <strong>–ö–ª–∞—Å—Ç–µ—Ä {{ loop.index }}:</strong>
                            –¶–µ–Ω—Ç—Ä = <span class="value">{{ "%.4f"|format(cluster.center) }}</span>,
                            –î—ñ–∞–ø–∞–∑–æ–Ω = [{{ "%.4f"|format(cluster.range[0]) }}, {{ "%.4f"|format(cluster.range[1]) }}],
                            –¢–æ—á–æ–∫ = {{ cluster.points }} ({{ "%.2f"|format((cluster.points / total_points * 100) if total_points > 0 else 0) }}%)
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
            
            <!-- –ö–≤–∞–Ω—Ç–∏–ª—ñ -->
            {% if out_analysis.quantiles.median is not none %}
            <div class="method-section quantiles">
                <h3>
                    <span class="method-icon"></span>
                    –ö–≤–∞–Ω—Ç–∏–ª—ñ —Ç–∞ –º–µ–¥—ñ–∞–Ω–∞
                </h3>
                <div class="result-item">
                    <strong>–ú–µ–¥—ñ–∞–Ω–∞ (Q2, 50-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å):</strong>
                    <span class="value">{{ "%.4f"|format(out_analysis.quantiles.median) }}</span>
                </div>
                <div class="result-item">
                    <strong>Q1 (25-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å):</strong>
                    <span class="value">{{ "%.4f"|format(out_analysis.quantiles.q1) }}</span>
                </div>
                <div class="result-item">
                    <strong>Q3 (75-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å):</strong>
                    <span class="value">{{ "%.4f"|format(out_analysis.quantiles.q3) }}</span>
                </div>
                <div class="result-item">
                    <strong>–Ü–Ω—Ç–µ—Ä–∫–≤–∞—Ä—Ç–∏–ª—å–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω (IQR = Q3 - Q1):</strong>
                    <span class="value">{{ "%.4f"|format(out_analysis.quantiles.iqr) }}</span>
                </div>
                <div class="result-item">
                    <strong>–î—ñ–∞–ø–∞–∑–æ–Ω Q1-Q3:</strong>
                    <span class="value">[{{ "%.4f"|format(out_analysis.quantiles.q1) }}, {{ "%.4f"|format(out_analysis.quantiles.q3) }}]</span>
                    <br><small style="color: #666;">–¶–µ –¥—ñ–∞–ø–∞–∑–æ–Ω, –≤ —è–∫–æ–º—É –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è 50% –≤—Å—ñ—Ö –∑–Ω–∞—á–µ–Ω—å</small>
                </div>
            </div>
            {% endif %}
            
        </div>
    </div>
    
    <script>
        var data = [
            {
                x: {{ timestamps|tojson }},
                y: {{ in_values|tojson }},
                type: 'scatter',
                mode: 'lines',
                name: 'In',
                line: {
                    color: '#1abc9c',
                    width: 2
                },
                hovertemplate: '<b>In</b><br>–ß–∞—Å: %{x}<br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<extra></extra>'
            },
            {
                x: {{ timestamps|tojson }},
                y: {{ out_values|tojson }},
                type: 'scatter',
                mode: 'lines',
                name: 'Out',
                line: {
                    color: '#e74c3c',
                    width: 2
                },
                hovertemplate: '<b>Out</b><br>–ß–∞—Å: %{x}<br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<extra></extra>'
            }
        ];
        
        {% if current_in is not none and last_timestamp %}
        data.push({
            x: [{{ last_timestamp|tojson }}, {{ last_timestamp|tojson }}],
            y: [{{ current_in|tojson }}, {{ current_in|tojson }}],
            type: 'scatter',
            mode: 'lines',
            name: 'In (–ø–æ—Ç–æ—á–Ω–µ)',
            line: {
                color: '#1abc9c',
                width: 1,
                dash: 'dash'
            },
            showlegend: false,
            hovertemplate: '<b>In (–ø–æ—Ç–æ—á–Ω–µ)</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<extra></extra>'
        });
        {% endif %}
        
        {% if current_out is not none and last_timestamp %}
        data.push({
            x: [{{ last_timestamp|tojson }}, {{ last_timestamp|tojson }}],
            y: [{{ current_out|tojson }}, {{ current_out|tojson }}],
            type: 'scatter',
            mode: 'lines',
            name: 'Out (–ø–æ—Ç–æ—á–Ω–µ)',
            line: {
                color: '#e74c3c',
                width: 1,
                dash: 'dash'
            },
            showlegend: false,
            hovertemplate: '<b>Out (–ø–æ—Ç–æ—á–Ω–µ)</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<extra></extra>'
        });
        {% endif %}
        
        // –î–æ–¥–∞—î–º–æ –¥–∞–Ω—ñ –∞–Ω–∞–ª—ñ–∑—É –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –∑–Ω–∞—á–µ–Ω—å out
        var outAnalysis = {{ out_analysis|tojson }};
        var shapes = [];
        var annotations = [];
        
        // 1. Density plot (KDE) - –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —è–∫ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É –ª—ñ–Ω—ñ—é –Ω–∞ –ø–æ—á–∞—Ç–∫—É –≥—Ä–∞—Ñ—ñ–∫—É
        {% if out_analysis.kde.density_x and out_analysis.kde.density_x|length > 0 %}
        var kdeX = {{ out_analysis.kde.density_x|tojson }};
        var kdeY = {{ out_analysis.kde.density_y|tojson }};
        var timestamps = {{ timestamps|tojson }};
        var firstTimestamp = timestamps[0];
        
        // –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ —â—ñ–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
        var maxDensity = Math.max(...kdeY);
        var minY = Math.min(...{{ out_values|tojson }});
        var maxY = Math.max(...{{ out_values|tojson }});
        var yRange = maxY - minY;
        
        // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–æ—á–∫–∏ –¥–ª—è density plot - –∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ Y, —á–∞—Å –ø–æ X (—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π –Ω–∞ –ø–æ—á–∞—Ç–∫—É)
        // –ú–∞—Å—à—Ç–∞–±—É—î–º–æ —à–∏—Ä–∏–Ω—É density plot –¥–æ 5% –≤—ñ–¥ –¥—ñ–∞–ø–∞–∑–æ–Ω—É —á–∞—Å—É
        var timeRange = new Date(timestamps[timestamps.length - 1]) - new Date(firstTimestamp);
        var densityWidth = timeRange * 0.05;
        var scaledDensityX = [];
        var scaledDensityY = [];
        
        for (var i = 0; i < kdeX.length; i++) {
            // X –ø–æ–∑–∏—Ü—ñ—è –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—ó —â—ñ–ª—å–Ω–æ—Å—Ç—ñ
            var densityRatio = kdeY[i] / maxDensity;
            var xPos = new Date(firstTimestamp).getTime() + densityWidth * densityRatio;
            scaledDensityX.push(new Date(xPos).toISOString());
            scaledDensityY.push(kdeX[i]);
        }
        
        data.push({
            x: scaledDensityX,
            y: scaledDensityY,
            type: 'scatter',
            mode: 'lines',
            name: 'KDE (—â—ñ–ª—å–Ω—ñ—Å—Ç—å)',
            line: {
                color: '#9b59b6',
                width: 2,
                dash: 'dot'
            },
            fill: 'tozeroy',
            fillcolor: 'rgba(155, 89, 182, 0.1)',
            hovertemplate: '<b>KDE</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<br>–©—ñ–ª—å–Ω—ñ—Å—Ç—å: %{customdata:.4f}<extra></extra>',
            customdata: kdeY
        });
        {% endif %}
        
        // 2. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ñ –ª—ñ–Ω—ñ—ó –¥–ª—è –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –∑–Ω–∞—á–µ–Ω—å
        // –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ - –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏–π –±—ñ–Ω
        {% if out_analysis.histogram.most_frequent_bin %}
        var histBin = {{ out_analysis.histogram.most_frequent_bin|tojson }};
        var histCenter = (histBin[0] + histBin[1]) / 2;
        shapes.push({
            type: 'line',
            x0: {{ timestamps|tojson }}[0],
            x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y0: histCenter,
            y1: histCenter,
            line: {
                color: '#3498db',
                width: 2,
                dash: 'dash'
            }
        });
        annotations.push({
            x: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y: histCenter,
            text: '–ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞: ' + histCenter.toFixed(4),
            showarrow: true,
            arrowhead: 2,
            arrowcolor: '#3498db',
            bgcolor: 'rgba(52, 152, 219, 0.8)',
            bordercolor: '#3498db',
            font: { color: 'white', size: 10 }
        });
        {% endif %}
        
        // –ú–æ–¥–∞
        {% if out_analysis["mode"]["value"] is not none %}
        var modeValue = {{ out_analysis["mode"]["value"]|tojson }};
        shapes.push({
            type: 'line',
            x0: {{ timestamps|tojson }}[0],
            x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y0: modeValue,
            y1: modeValue,
            line: {
                color: '#e67e22',
                width: 2,
                dash: 'dash'
            }
        });
        annotations.push({
            x: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y: modeValue,
            text: '–ú–æ–¥–∞: ' + modeValue.toFixed(4),
            showarrow: true,
            arrowhead: 2,
            arrowcolor: '#e67e22',
            bgcolor: 'rgba(230, 126, 34, 0.8)',
            bordercolor: '#e67e22',
            font: { color: 'white', size: 10 }
        });
        {% endif %}
        
        // –ö–≤–∞–Ω—Ç–∏–ª—ñ - –º–µ–¥—ñ–∞–Ω–∞, Q1, Q3
        {% if out_analysis.quantiles.median is not none %}
        var median = {{ out_analysis.quantiles.median|tojson }};
        var q1 = {{ out_analysis.quantiles.q1|tojson }};
        var q3 = {{ out_analysis.quantiles.q3|tojson }};
        
        // –ú–µ–¥—ñ–∞–Ω–∞
        shapes.push({
            type: 'line',
            x0: {{ timestamps|tojson }}[0],
            x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y0: median,
            y1: median,
            line: {
                color: '#8b4513',
                width: 2,
                dash: 'dot'
            }
        });
        
        // Q1 —Ç–∞ Q3 - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ñ —Å–º—É–≥–∏
        shapes.push({
            type: 'rect',
            x0: {{ timestamps|tojson }}[0],
            x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y0: q1,
            y1: q3,
            fillcolor: 'rgba(139, 69, 19, 0.1)',
            line: {
                color: '#8b4513',
                width: 1,
                dash: 'dot'
            }
        });
        
        annotations.push({
            x: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y: median,
            text: '–ú–µ–¥—ñ–∞–Ω–∞: ' + median.toFixed(4),
            showarrow: true,
            arrowhead: 2,
            arrowcolor: '#8b4513',
            bgcolor: 'rgba(139, 69, 19, 0.8)',
            bordercolor: '#8b4513',
            font: { color: 'white', size: 10 }
        });
        {% endif %}
        
        // KDE –ø—ñ–∫–∏
        {% if out_analysis.kde.peaks and out_analysis.kde.peaks|length > 0 %}
        var kdePeaks = {{ out_analysis.kde.peaks|tojson }};
        // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏ –¥–ª—è —Ç–æ–ø-3 –ø—ñ–∫—ñ–≤
        var topPeaks = kdePeaks.slice(0, Math.min(3, kdePeaks.length));
        topPeaks.forEach(function(peak, index) {
            shapes.push({
                type: 'line',
                x0: {{ timestamps|tojson }}[0],
                x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
                y0: peak,
                y1: peak,
                line: {
                    color: '#9b59b6',
                    width: 1.5,
                    dash: 'dot'
                }
            });
        });
        {% endif %}
        
        // –ó–∞–≥–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è –∑ —É—Å—ñ—Ö –º–µ—Ç–æ–¥–∏–∫
        {% if average_from_methods and average_from_methods.average is not none %}
        var overallAvg = {{ average_from_methods.average|tojson }};
        shapes.push({
            type: 'line',
            x0: {{ timestamps|tojson }}[0],
            x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y0: overallAvg,
            y1: overallAvg,
            line: {
                color: '#667eea',
                width: 3,
                dash: 'solid'
            }
        });
        annotations.push({
            x: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y: overallAvg,
            text: '–°–µ—Ä–µ–¥–Ω—î Out: ' + overallAvg.toFixed(4),
            showarrow: true,
            arrowhead: 2,
            arrowcolor: '#667eea',
            ax: 0,
            ay: -40,
            bgcolor: 'rgba(102, 126, 234, 0.9)',
            bordercolor: '#667eea',
            font: { color: 'white', size: 11, weight: 'bold' }
        });
        {% endif %}

        // –ó–∞–≥–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è In (–∑ —É—Å—ñ—Ö –º–µ—Ç–æ–¥–∏–∫ / simple / both –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ avg_method)
        {% if average_in_from_methods and average_in_from_methods.average is not none %}
        var overallAvgIn = {{ average_in_from_methods.average|tojson }};
        shapes.push({
            type: 'line',
            x0: {{ timestamps|tojson }}[0],
            x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y0: overallAvgIn,
            y1: overallAvgIn,
            line: {
                color: '#1abc9c',
                width: 3,
                dash: 'solid'
            }
        });
        annotations.push({
            x: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y: overallAvgIn,
            text: '–°–µ—Ä–µ–¥–Ω—î In: ' + overallAvgIn.toFixed(4),
            showarrow: true,
            arrowhead: 2,
            arrowcolor: '#1abc9c',
            ax: 0,
            ay: 40,
            bgcolor: 'rgba(26, 188, 156, 0.9)',
            bordercolor: '#1abc9c',
            font: { color: 'white', size: 11, weight: 'bold' }
        });
        {% endif %}

        // –†—ñ–≤–µ–Ω—å –≤—Ö–æ–¥—É –ø–æ In (EntryIn) - —á–µ—Ä–≤–æ–Ω–∞ –ª—ñ–Ω—ñ—è
        {% if entry_in_level is not none %}
        var entryInLevel = {{ entry_in_level|tojson }};
        shapes.push({
            type: 'line',
            x0: {{ timestamps|tojson }}[0],
            x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y0: entryInLevel,
            y1: entryInLevel,
            line: {
                color: '#ff0000',
                width: 4,
                dash: 'solid'
            }
        });
        annotations.push({
            x: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y: entryInLevel,
            text: '–í—Ö—ñ–¥ In: ' + entryInLevel.toFixed(4),
            showarrow: true,
            arrowhead: 2,
            arrowcolor: '#ff0000',
            ax: 0,
            ay: 60,
            bgcolor: 'rgba(255, 0, 0, 0.85)',
            bordercolor: '#ff0000',
            font: { color: 'white', size: 11, weight: 'bold' }
        });
        {% endif %}

        // –†—ñ–≤–µ–Ω—å –≤–∏—Ö–æ–¥—É –ø–æ Out (ExitOut) - —á–æ—Ä–Ω–∞ –ª—ñ–Ω—ñ—è
        {% if exit_out_level is not none %}
        var exitOutLevel = {{ exit_out_level|tojson }};
        shapes.push({
            type: 'line',
            x0: {{ timestamps|tojson }}[0],
            x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y0: exitOutLevel,
            y1: exitOutLevel,
            line: {
                color: '#000000',
                width: 4,
                dash: 'solid'
            }
        });
        annotations.push({
            x: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
            y: exitOutLevel,
            text: '–í–∏—Ö—ñ–¥ Out: ' + exitOutLevel.toFixed(4),
            showarrow: true,
            arrowhead: 2,
            arrowcolor: '#000000',
            ax: 0,
            ay: -60,
            bgcolor: 'rgba(0, 0, 0, 0.85)',
            bordercolor: '#000000',
            font: { color: 'white', size: 11, weight: 'bold' }
        });
        {% endif %}
        
        // –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—è - —Ü–µ–Ω—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤
        {% if out_analysis.clustering.clusters and out_analysis.clustering.clusters|length > 0 %}
        var clusters = {{ out_analysis.clustering.clusters|tojson }};
        // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏ –¥–ª—è —Ç–æ–ø-3 –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤
        var topClusters = clusters.slice(0, Math.min(3, clusters.length));
        topClusters.forEach(function(cluster, index) {
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –ª—ñ–Ω—ñ—è –¥–ª—è —Ü–µ–Ω—Ç—Ä—É –∫–ª–∞—Å—Ç–µ—Ä–∞
            shapes.push({
                type: 'line',
                x0: {{ timestamps|tojson }}[0],
                x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
                y0: cluster.center,
                y1: cluster.center,
                line: {
                    color: '#27ae60',
                    width: 1.5,
                    dash: 'dot'
                }
            });
            
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞ —Å–º—É–≥–∞ –¥–ª—è –¥—ñ–∞–ø–∞–∑–æ–Ω—É –∫–ª–∞—Å—Ç–µ—Ä–∞
            shapes.push({
                type: 'rect',
                x0: {{ timestamps|tojson }}[0],
                x1: {{ timestamps|tojson }}[{{ timestamps|length - 1 }}],
                y0: cluster.range[0],
                y1: cluster.range[1],
                fillcolor: 'rgba(39, 174, 96, 0.05)',
                line: {
                    color: '#27ae60',
                    width: 1,
                    dash: 'dot'
                }
            });
        });
        {% endif %}
        
        // 3. –ú–∞—Ä–∫–µ—Ä–∏ –¥–ª—è –Ω–∞–π—á–∞—Å—Ç—ñ—à–∏—Ö –∑–Ω–∞—á–µ–Ω—å
        var markerData = [];
        
        // –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ - —Ü–µ–Ω—Ç—Ä –Ω–∞–π—á–∞—Å—Ç—ñ—à–æ–≥–æ –±—ñ–Ω—É
        {% if out_analysis.histogram.most_frequent_bin %}
        var histBinMarker = {{ out_analysis.histogram.most_frequent_bin|tojson }};
        var histCenter = (histBinMarker[0] + histBinMarker[1]) / 2;
        markerData.push({
            x: [{{ timestamps|tojson }}[Math.floor({{ timestamps|length }} / 2)]],
            y: [histCenter],
            type: 'scatter',
            mode: 'markers',
            name: '–ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞',
            marker: {
                color: '#3498db',
                size: 12,
                symbol: 'diamond'
            },
            hovertemplate: '<b>–ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<br>–ß–∞—Å—Ç–æ—Ç–∞: {{ out_analysis.histogram.frequency }}<extra></extra>'
        });
        {% endif %}
        
        // –ú–æ–¥–∞
        {% if out_analysis["mode"]["value"] is not none %}
        var modeValueMarker = {{ out_analysis["mode"]["value"]|tojson }};
        markerData.push({
            x: [{{ timestamps|tojson }}[Math.floor({{ timestamps|length }} / 2)]],
            y: [modeValueMarker],
            type: 'scatter',
            mode: 'markers',
            name: '–ú–æ–¥–∞',
            marker: {
                color: '#e67e22',
                size: 12,
                symbol: 'square'
            },
            hovertemplate: '<b>–ú–æ–¥–∞</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<br>–ß–∞—Å—Ç–æ—Ç–∞: {{ out_analysis["mode"]["frequency"] }}<extra></extra>'
        });
        {% endif %}
        
        // KDE –ø—ñ–∫–∏
        {% if out_analysis.kde.peaks and out_analysis.kde.peaks|length > 0 %}
        var kdePeaks = {{ out_analysis.kde.peaks|tojson }};
        var topKdePeaks = kdePeaks.slice(0, Math.min(3, kdePeaks.length));
        markerData.push({
            x: topKdePeaks.map(function() { return {{ timestamps|tojson }}[Math.floor({{ timestamps|length }} / 2)]; }),
            y: topKdePeaks,
            type: 'scatter',
            mode: 'markers',
            name: 'KDE –ø—ñ–∫–∏',
            marker: {
                color: '#9b59b6',
                size: 10,
                symbol: 'circle'
            },
            hovertemplate: '<b>KDE –ø—ñ–∫</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<extra></extra>'
        });
        {% endif %}
        
        // –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—è
        {% if out_analysis.clustering.clusters and out_analysis.clustering.clusters|length > 0 %}
        var clusters = {{ out_analysis.clustering.clusters|tojson }};
        var topClusters = clusters.slice(0, Math.min(3, clusters.length));
        markerData.push({
            x: topClusters.map(function() { return {{ timestamps|tojson }}[Math.floor({{ timestamps|length }} / 2)]; }),
            y: topClusters.map(function(c) { return c.center; }),
            type: 'scatter',
            mode: 'markers',
            name: '–ö–ª–∞—Å—Ç–µ—Ä–∏',
            marker: {
                color: '#27ae60',
                size: 10,
                symbol: 'triangle-up'
            },
            hovertemplate: '<b>–ö–ª–∞—Å—Ç–µ—Ä</b><br>–¶–µ–Ω—Ç—Ä: %{y:.4f}<br>–¢–æ—á–æ–∫: %{customdata}<extra></extra>',
            customdata: topClusters.map(function(c) { return c.points; })
        });
        {% endif %}
        
        // –ó–∞–≥–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è
        {% if average_from_methods and average_from_methods.average is not none %}
        var overallAvgMarker = {{ average_from_methods.average|tojson }};
        markerData.push({
            x: [{{ timestamps|tojson }}[Math.floor({{ timestamps|length }} / 2)]],
            y: [overallAvgMarker],
            type: 'scatter',
            mode: 'markers',
            name: '–°–µ—Ä–µ–¥–Ω—î Out (–≤—Å—ñ –º–µ—Ç–æ–¥–∏–∫–∏)',
            marker: {
                color: '#667eea',
                size: 15,
                symbol: 'star',
                line: {
                    color: 'white',
                    width: 2
                }
            },
            hovertemplate: '<b>–°–µ—Ä–µ–¥–Ω—î –∑ —É—Å—ñ—Ö –º–µ—Ç–æ–¥–∏–∫</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<br>–û–±—á–∏—Å–ª–µ–Ω–æ –∑: {{ average_from_methods.count }} –º–µ—Ç–æ–¥–∏–∫<extra></extra>'
        });
        {% endif %}

        // –ó–∞–≥–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è In
        {% if average_in_from_methods and average_in_from_methods.average is not none %}
        var overallAvgInMarker = {{ average_in_from_methods.average|tojson }};
        markerData.push({
            x: [{{ timestamps|tojson }}[Math.floor({{ timestamps|length }} / 2)]],
            y: [overallAvgInMarker],
            type: 'scatter',
            mode: 'markers',
            name: '–°–µ—Ä–µ–¥–Ω—î In (–≤—Å—ñ –º–µ—Ç–æ–¥–∏–∫–∏)',
            marker: {
                color: '#1abc9c',
                size: 15,
                symbol: 'star',
                line: {
                    color: 'white',
                    width: 2
                }
            },
            hovertemplate: '<b>–°–µ—Ä–µ–¥–Ω—î In</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<br>–û–±—á–∏—Å–ª–µ–Ω–æ –∑: {{ average_in_from_methods.count }} –º–µ—Ç–æ–¥–∏–∫<extra></extra>'
        });
        {% endif %}
        
        // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏ –¥–æ data
        markerData.forEach(function(marker) {
            data.push(marker);
        });
        
        // 4. –ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ —Ä–æ–∑–ø–æ–¥—ñ–ª—É (–≤—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —è–∫ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ñ —Å–º—É–≥–∏)
        {% if out_analysis.histogram.bin_edges and out_analysis.histogram.bin_edges|length > 1 %}
        var histBins = {{ out_analysis.histogram.bin_edges|tojson }};
        var histFreqs = {{ out_analysis.histogram.frequencies|tojson }};
        var timestamps = {{ timestamps|tojson }};
        var firstTimestamp = timestamps[0];
        var lastTimestamp = timestamps[timestamps.length - 1];
        
        // –î–æ–¥–∞—î–º–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ñ —Å–º—É–≥–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –±—ñ–Ω—É (–ø—Ä–æ–ø–æ—Ä—Ü—ñ–π–Ω–æ –¥–æ —á–∞—Å—Ç–æ—Ç–∏)
        var maxFreq = Math.max(...histFreqs);
        for (var i = 0; i < histBins.length - 1; i++) {
            if (histFreqs[i] > 0) {
                var binStart = histBins[i];
                var binEnd = histBins[i + 1];
                var freq = histFreqs[i];
                var width = (new Date(lastTimestamp) - new Date(firstTimestamp)) * (freq / maxFreq) * 0.3;
                var xPos = new Date(firstTimestamp).getTime() + (new Date(lastTimestamp) - new Date(firstTimestamp)) * 0.1;
                
                shapes.push({
                    type: 'rect',
                    x0: new Date(xPos).toISOString(),
                    x1: new Date(xPos + width).toISOString(),
                    y0: binStart,
                    y1: binEnd,
                    fillcolor: 'rgba(52, 152, 219, ' + (0.1 + freq / maxFreq * 0.2) + ')',
                    line: {
                        color: '#3498db',
                        width: 1
                    },
                    layer: 'below'
                });
            }
        }
        {% endif %}
        
        var layout = {
            title: {
                text: '–Ü—Å—Ç–æ—Ä–∏—á–Ω–∏–π —Å–ø—Ä–µ–¥ - In —Ç–∞ Out',
                font: {
                    size: 18,
                    color: '#333'
                }
            },
            xaxis: {
                title: '–ß–∞—Å',
                showgrid: true,
                gridcolor: '#e0e0e0',
                zeroline: false
            },
            yaxis: {
                title: '–ó–Ω–∞—á–µ–Ω–Ω—è —Å–ø—Ä–µ–¥—É',
                showgrid: true,
                gridcolor: '#e0e0e0',
                zeroline: true,
                zerolinecolor: '#999',
                zerolinewidth: 1
            },
            hovermode: 'x unified',
            legend: {
                x: 0,
                y: 1,
                bgcolor: 'rgba(255,255,255,0.8)',
                bordercolor: '#ccc',
                borderwidth: 1
            },
            plot_bgcolor: 'white',
            paper_bgcolor: 'white',
            margin: {
                l: 60,
                r: 30,
                t: 60,
                b: 60
            },
            shapes: shapes,
            annotations: annotations
        };
        
        var config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
            toImageButtonOptions: {
                format: 'png',
                filename: 'spread_chart',
                height: 600,
                width: 1400,
                scale: 1
            }
        };
        
        Plotly.newPlot('chart', data, layout, config);
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É –ø—Ä–∏ –∑–º—ñ–Ω—ñ –≤—ñ–∫–Ω–∞
        window.addEventListener('resize', function() {
            Plotly.Plots.resize('chart');
        });
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π URL –¥–ª—è AJAX –∑–∞–ø–∏—Ç—ñ–≤
        var currentUrl = {{ url|tojson }};
        var currentData = {
            timestamps: {{ timestamps|tojson }},
            in_values: {{ in_values|tojson }},
            out_values: {{ out_values|tojson }},
            current_in: {{ current_in|tojson }},
            current_out: {{ current_out|tojson }},
            total_points: {{ total_points }},
            time_range: {{ time_range|tojson }},
            out_analysis: {{ out_analysis|tojson }},
            in_analysis: {{ in_analysis|tojson }},
            lookback_checks: {{ lookback_checks|tojson }},
            average_from_methods: {{ average_from_methods|tojson }},
            average_in_from_methods: {{ average_in_from_methods|tojson }}
        };
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞ —á–µ—Ä–µ–∑ AJAX
        async function updateChart() {
            const updateBtn = document.getElementById('updateBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ —Ñ–æ—Ä–º–∏
            const limit = parseInt(document.getElementById('settings_limit').value) || 10000;
            const tolerance = parseFloat(document.getElementById('settings_tolerance').value) || 0.01;
            const avgMethod = document.getElementById('settings_avg_method').value || 'methods';
            const useHistogram = document.getElementById('settings_use_histogram').checked;
            const useMode = document.getElementById('settings_use_mode').checked;
            const useKde = document.getElementById('settings_use_kde').checked;
            const useClustering = document.getElementById('settings_use_clustering').checked;
            const useQuantiles = document.getElementById('settings_use_quantiles').checked;
            
            // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            updateBtn.disabled = true;
            updateBtn.textContent = '–û–Ω–æ–≤–ª–µ–Ω–Ω—è...';
            loadingIndicator.classList.add('show');
            
            try {
                // –§–æ—Ä–º—É—î–º–æ URL –¥–ª—è AJAX –∑–∞–ø–∏—Ç—É
                const params = new URLSearchParams({
                    url: currentUrl,
                    limit: limit,
                    tolerance: tolerance,
                    format: 'json',
                    avg_method: avgMethod,
                    use_histogram: useHistogram ? 'true' : 'false',
                    use_mode: useMode ? 'true' : 'false',
                    use_kde: useKde ? 'true' : 'false',
                    use_clustering: useClustering ? 'true' : 'false',
                    use_quantiles: useQuantiles ? 'true' : 'false'
                });
                
                const response = await fetch('/analyze?' + params.toString());
                
                if (!response.ok) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
                }
                
                const newData = await response.json();
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –≥—Ä–∞—Ñ—ñ–∫
                updatePlotlyChart(newData);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStatistics(newData);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
                updateCurrentValues(newData);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
                updateInfo(newData);
                
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–æ–≤—ñ –¥–∞–Ω—ñ
                currentData = newData;
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: ' + error.message);
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'üîÑ –û–Ω–æ–≤–∏—Ç–∏';
                loadingIndicator.classList.remove('show');
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –≥—Ä–∞—Ñ—ñ–∫–∞ –∑ –Ω–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
        function createChartDataFromResponse(data) {
            var chartData = [
                {
                    x: data.timestamps,
                    y: data.in_values,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'In',
                    line: {
                        color: '#1abc9c',
                        width: 2
                    },
                    hovertemplate: '<b>In</b><br>–ß–∞—Å: %{x}<br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<extra></extra>'
                },
                {
                    x: data.timestamps,
                    y: data.out_values,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Out',
                    line: {
                        color: '#e74c3c',
                        width: 2
                    },
                    hovertemplate: '<b>Out</b><br>–ß–∞—Å: %{x}<br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<extra></extra>'
                }
            ];
            
            // –î–æ–¥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
            const lastTimestamp = data.timestamps && data.timestamps.length > 0 ? data.timestamps[data.timestamps.length - 1] : null;
            if (data.current_in !== null && lastTimestamp) {
                chartData.push({
                    x: [lastTimestamp, lastTimestamp],
                    y: [data.current_in, data.current_in],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'In (–ø–æ—Ç–æ—á–Ω–µ)',
                    line: {
                        color: '#1abc9c',
                        width: 1,
                        dash: 'dash'
                    },
                    showlegend: false,
                    hovertemplate: '<b>In (–ø–æ—Ç–æ—á–Ω–µ)</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<extra></extra>'
                });
            }
            
            if (data.current_out !== null && lastTimestamp) {
                chartData.push({
                    x: [lastTimestamp, lastTimestamp],
                    y: [data.current_out, data.current_out],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Out (–ø–æ—Ç–æ—á–Ω–µ)',
                    line: {
                        color: '#e74c3c',
                        width: 1,
                        dash: 'dash'
                    },
                    showlegend: false,
                    hovertemplate: '<b>Out (–ø–æ—Ç–æ—á–Ω–µ)</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<extra></extra>'
                });
            }
            
            // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä –¥–ª—è —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è
            if (data.average_from_methods && data.average_from_methods.average !== null && lastTimestamp) {
                const overallAvg = data.average_from_methods.average;
                const midTimestamp = data.timestamps[Math.floor(data.timestamps.length / 2)];
                chartData.push({
                    x: [midTimestamp],
                    y: [overallAvg],
                    type: 'scatter',
                    mode: 'markers',
                    name: '–°–µ—Ä–µ–¥–Ω—î Out (–≤—Å—ñ –º–µ—Ç–æ–¥–∏–∫–∏)',
                    marker: {
                        color: '#667eea',
                        size: 12,
                        symbol: 'star'
                    },
                    hovertemplate: '<b>–°–µ—Ä–µ–¥–Ω—î –∑ —É—Å—ñ—Ö –º–µ—Ç–æ–¥–∏–∫</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<br>–û–±—á–∏—Å–ª–µ–Ω–æ –∑: ' + 
                        data.average_from_methods.count + ' –º–µ—Ç–æ–¥–∏–∫<extra></extra>'
                });
            }

            // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä –¥–ª—è —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è In
            if (data.average_in_from_methods && data.average_in_from_methods.average !== null && lastTimestamp) {
                const overallAvgIn = data.average_in_from_methods.average;
                const midTimestamp = data.timestamps[Math.floor(data.timestamps.length / 2)];
                chartData.push({
                    x: [midTimestamp],
                    y: [overallAvgIn],
                    type: 'scatter',
                    mode: 'markers',
                    name: '–°–µ—Ä–µ–¥–Ω—î In (–≤—Å—ñ –º–µ—Ç–æ–¥–∏–∫–∏)',
                    marker: {
                        color: '#1abc9c',
                        size: 12,
                        symbol: 'star'
                    },
                    hovertemplate: '<b>–°–µ—Ä–µ–¥–Ω—î In</b><br>–ó–Ω–∞—á–µ–Ω–Ω—è: %{y:.4f}<br>–û–±—á–∏—Å–ª–µ–Ω–æ –∑: ' +
                        data.average_in_from_methods.count + ' –º–µ—Ç–æ–¥–∏–∫<extra></extra>'
                });
            }
            
            return chartData;
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è layout –∑ –Ω–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö
        function createChartLayoutFromResponse(data) {
            var shapes = [];
            var annotations = [];
            const firstTimestamp = (data.timestamps && data.timestamps.length > 0) ? data.timestamps[0] : null;
            const lastTimestamp = (data.timestamps && data.timestamps.length > 0) ? data.timestamps[data.timestamps.length - 1] : null;
            
            // –î–æ–¥–∞—î–º–æ –ª—ñ–Ω—ñ—é —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è
            if (data.average_from_methods && data.average_from_methods.average !== null && data.timestamps && data.timestamps.length > 0) {
                const overallAvg = data.average_from_methods.average;
                const firstTimestamp = data.timestamps[0];
                const lastTimestamp = data.timestamps[data.timestamps.length - 1];
                
                shapes.push({
                    type: 'line',
                    x0: firstTimestamp,
                    x1: lastTimestamp,
                    y0: overallAvg,
                    y1: overallAvg,
                    line: {
                        color: '#667eea',
                        width: 3,
                        dash: 'solid'
                    }
                });
                
                annotations.push({
                    x: lastTimestamp,
                    y: overallAvg,
                    text: '–°–µ—Ä–µ–¥–Ω—î Out: ' + overallAvg.toFixed(4),
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#667eea',
                    ax: 0,
                    ay: -40,
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: '#667eea',
                    borderwidth: 1,
                    font: {
                        color: '#667eea',
                        size: 12
                    }
                });
            }

            // –î–æ–¥–∞—î–º–æ –ª—ñ–Ω—ñ—é —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è In
            if (data.average_in_from_methods && data.average_in_from_methods.average !== null && data.timestamps && data.timestamps.length > 0) {
                const overallAvgIn = data.average_in_from_methods.average;
                const firstTimestamp = data.timestamps[0];
                const lastTimestamp = data.timestamps[data.timestamps.length - 1];

                shapes.push({
                    type: 'line',
                    x0: firstTimestamp,
                    x1: lastTimestamp,
                    y0: overallAvgIn,
                    y1: overallAvgIn,
                    line: {
                        color: '#1abc9c',
                        width: 3,
                        dash: 'solid'
                    }
                });

                annotations.push({
                    x: lastTimestamp,
                    y: overallAvgIn,
                    text: '–°–µ—Ä–µ–¥–Ω—î In: ' + overallAvgIn.toFixed(4),
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#1abc9c',
                    ax: 0,
                    ay: 40,
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: '#1abc9c',
                    borderwidth: 1,
                    font: {
                        color: '#1abc9c',
                        size: 12
                    }
                });
            }

            // –†—ñ–≤–Ω—ñ EntryIn / ExitOut (–Ω–æ–≤—ñ –ª—ñ–Ω—ñ—ó)
            if (data.entry_in_level !== null && data.entry_in_level !== undefined && firstTimestamp && lastTimestamp) {
                const entryInLevel = data.entry_in_level;
                shapes.push({
                    type: 'line',
                    x0: firstTimestamp,
                    x1: lastTimestamp,
                    y0: entryInLevel,
                    y1: entryInLevel,
                    line: { color: '#ff0000', width: 4, dash: 'solid' }
                });
                annotations.push({
                    x: lastTimestamp,
                    y: entryInLevel,
                    text: '–í—Ö—ñ–¥ In: ' + Number(entryInLevel).toFixed(4),
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#ff0000',
                    ax: 0,
                    ay: 60,
                    bgcolor: 'rgba(255, 0, 0, 0.85)',
                    bordercolor: '#ff0000',
                    borderwidth: 1,
                    font: { color: 'white', size: 12 }
                });
            }

            if (data.exit_out_level !== null && data.exit_out_level !== undefined && firstTimestamp && lastTimestamp) {
                const exitOutLevel = data.exit_out_level;
                shapes.push({
                    type: 'line',
                    x0: firstTimestamp,
                    x1: lastTimestamp,
                    y0: exitOutLevel,
                    y1: exitOutLevel,
                    line: { color: '#000000', width: 4, dash: 'solid' }
                });
                annotations.push({
                    x: lastTimestamp,
                    y: exitOutLevel,
                    text: '–í–∏—Ö—ñ–¥ Out: ' + Number(exitOutLevel).toFixed(4),
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#000000',
                    ax: 0,
                    ay: -60,
                    bgcolor: 'rgba(0, 0, 0, 0.85)',
                    bordercolor: '#000000',
                    borderwidth: 1,
                    font: { color: 'white', size: 12 }
                });
            }
            
            return {
                title: {
                    text: '–Ü—Å—Ç–æ—Ä–∏—á–Ω–∏–π —Å–ø—Ä–µ–¥ - In —Ç–∞ Out',
                    font: {
                        size: 18,
                        color: '#333'
                    }
                },
                xaxis: {
                    title: '–ß–∞—Å',
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    zeroline: false
                },
                yaxis: {
                    title: '–ó–Ω–∞—á–µ–Ω–Ω—è —Å–ø—Ä–µ–¥—É',
                    showgrid: true,
                    gridcolor: '#e0e0e0',
                    zeroline: true,
                    zerolinecolor: '#999',
                    zerolinewidth: 1
                },
                hovermode: 'x unified',
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: '#ccc',
                    borderwidth: 1
                },
                plot_bgcolor: 'white',
                paper_bgcolor: 'white',
                margin: {
                    l: 60,
                    r: 30,
                    t: 60,
                    b: 60
                },
                shapes: shapes,
                annotations: annotations
            };
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞ Plotly
        function updatePlotlyChart(data) {
            const newData = createChartDataFromResponse(data);
            const newLayout = createChartLayoutFromResponse(data);
            
            // –ü–æ–≤–Ω—ñ—Å—Ç—é –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ –≥—Ä–∞—Ñ—ñ–∫
            Plotly.newPlot('chart', newData, newLayout, {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'spread_chart',
                    height: 600,
                    width: 1400,
                    scale: 1
                }
            });
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function formatNumber(value, decimals = 4) {
            if (value === null || value === undefined) return '‚Äî';
            const num = Number(value);
            if (Number.isNaN(num)) return '‚Äî';
            return num.toFixed(decimals);
        }

        function yesNoBadge(value) {
            return value ? '<span class="yn-yes">—Ç–∞–∫</span>' : '<span class="yn-no">–Ω—ñ</span>';
        }

        function renderLookbackHtml(lookback) {
            if (!lookback || !lookback.windows) {
                return '<div class="method-section" style="border-left-color: #999;"><p style="color: #666; margin: 0;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–∞ —á–∞—Å–æ–≤–∏–º–∏ –≤—ñ–∫–Ω–∞–º–∏.</p></div>';
            }

            const hoursList = Array.isArray(lookback.hours)
                ? lookback.hours
                : Object.keys(lookback.windows).map(h => parseInt(h, 10)).filter(n => !Number.isNaN(n)).sort((a, b) => a - b);

            const thresholds = Array.isArray(lookback.abs_thresholds) ? lookback.abs_thresholds : [];
            let thresholdKeys = thresholds.map(t => Number.isInteger(Number(t)) ? Number(t).toFixed(1) : String(t));

            if (!thresholdKeys || thresholdKeys.length === 0) {
                const firstKey = Object.keys(lookback.windows)[0];
                const firstWin = firstKey ? lookback.windows[firstKey] : null;
                if (firstWin && firstWin.in && firstWin.in.reached_abs) {
                    thresholdKeys = Object.keys(firstWin.in.reached_abs);
                } else {
                    thresholdKeys = [];
                }
            }

            let html = '<div class="lookback-grid">';

            hoursList.forEach(hours => {
                const win = lookback.windows[String(hours)];
                if (!win) return;

                html += '<div class="lookback-card">';
                html += `<h3>–û—Å—Ç–∞–Ω–Ω—ñ ${hours} –≥–æ–¥</h3>`;
                html += `<div class="result-item"><strong>–ü–µ—Ä—ñ–æ–¥:</strong> <span class="value">${win.start_time || '‚Äî'} ‚Äì ${win.end_time || '‚Äî'}</span> <span style="color:#666;">(${win.points ?? 0} —Ç–æ—á–æ–∫)</span></div>`;

                html += '<table class="lookback-table"><thead><tr><th></th><th>min</th><th>max</th><th>avg</th><th>crossed 0</th>';
                thresholdKeys.forEach(key => {
                    html += `<th>|x| ‚â§ ${key}</th>`;
                });
                html += '</tr></thead><tbody>';

                const renderRow = (label, row) => {
                    const stats = row && row.stats ? row.stats : {};
                    let rowHtml = `<tr><td class="lookback-row-label">${label}</td>`;
                    rowHtml += `<td>${formatNumber(stats.min, 4)}</td>`;
                    rowHtml += `<td>${formatNumber(stats.max, 4)}</td>`;
                    rowHtml += `<td>${formatNumber(stats.avg, 4)}</td>`;
                    rowHtml += `<td>${yesNoBadge(!!(row && row.crossed_zero))}</td>`;
                    thresholdKeys.forEach(key => {
                        const reached = row && row.reached_abs ? !!row.reached_abs[key] : false;
                        rowHtml += `<td>${yesNoBadge(reached)}</td>`;
                    });
                    rowHtml += '</tr>';
                    return rowHtml;
                };

                html += renderRow('In', win.in);
                html += renderRow('Out', win.out);

                html += '</tbody></table>';
                html += '</div>';
            });

            html += '</div>';
            return html;
        }

        function updateLookbackChecks(data) {
            const container = document.getElementById('lookbackContainer');
            if (!container) return;
            container.innerHTML = renderLookbackHtml(data.lookback_checks);
        }

        function updateAverageUI(prefix, avg) {
            if (!avg) return;

            const valueEl = document.getElementById(`avg_${prefix}_value`);
            if (valueEl && avg.average !== null && avg.average !== undefined) {
                valueEl.textContent = formatNumber(avg.average, 4);
            }

            const countEl = document.getElementById(`avg_${prefix}_count`);
            if (countEl && avg.count !== null && avg.count !== undefined) {
                countEl.textContent = String(avg.count);
            }

            const methodsEl = document.getElementById(`avg_${prefix}_methods`);
            if (methodsEl && Array.isArray(avg.method_names)) {
                methodsEl.textContent = avg.method_names.join(', ');
            }

            const listEl = document.getElementById(`avg_${prefix}_values_list`);
            if (listEl && Array.isArray(avg.values) && Array.isArray(avg.method_names)) {
                const items = avg.values.map((v, i) => {
                    const name = avg.method_names[i] || `–ú–µ—Ç–æ–¥ ${i + 1}`;
                    return `<li><strong>${name}:</strong> <span class="value">${formatNumber(v, 4)}</span></li>`;
                }).join('');
                listEl.innerHTML = items;
            }

            const rangeEl = document.getElementById(`avg_${prefix}_range`);
            if (rangeEl && avg.min !== null && avg.min !== undefined && avg.max !== null && avg.max !== undefined) {
                rangeEl.textContent = `[${formatNumber(avg.min, 4)}, ${formatNumber(avg.max, 4)}]`;
            }

            const stdEl = document.getElementById(`avg_${prefix}_std`);
            if (stdEl && avg.std !== null && avg.std !== undefined) {
                stdEl.textContent = formatNumber(avg.std, 4);
            }
        }

        function updateStatistics(data) {
            updateLookbackChecks(data);
            updateAverageUI('out', data.average_from_methods);
            updateAverageUI('in', data.average_in_from_methods);
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å
        function updateCurrentValues(data) {
            const inBox = document.querySelector('.value-box.in .value-number');
            const outBox = document.querySelector('.value-box.out .value-number');
            
            if (inBox && data.current_in !== null) {
                inBox.textContent = data.current_in.toFixed(2);
            }
            if (outBox && data.current_out !== null) {
                outBox.textContent = data.current_out.toFixed(2);
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
        function updateInfo(data) {
            const infoDiv = document.querySelector('.info');
            if (infoDiv) {
                infoDiv.innerHTML = '<strong>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</strong> –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫: ' + 
                    data.total_points + ' | –î—ñ–∞–ø–∞–∑–æ–Ω: ' + data.time_range;
            }
        }
        
        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ—ó –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û–Ω–æ–≤–∏—Ç–∏"
        document.getElementById('updateBtn').addEventListener('click', updateChart);
    </script>
</body>
</html>

