# Аналіз точок сходження історичного спреду

FastAPI додаток для аналізу історичних даних спреду: знаходження точок сходження, визначення найчастішого значення спреду та візуалізація даних у вигляді інтерактивної діаграми.

Додатково реалізовано:
- ✅ **Окремий аналіз для `in` та `out`** (середні значення та статистичні методики)
- ✅ **Перевірка “сходження до 0/порогів” та перетину 0** за останні **2/4/8/16 годин** (min/max/avg)

## Встановлення

### Крок 1: Створення віртуального середовища (рекомендовано)

**Windows (PowerShell):**
```powershell
# Створити віртуальне середовище
python -m venv venv

# Активувати віртуальне середовище
.\venv\Scripts\Activate.ps1
```

**Windows (Command Prompt):**
```cmd
# Створити віртуальне середовище
python -m venv venv

# Активувати віртуальне середовище
venv\Scripts\activate.bat
```

**Linux/Mac:**
```bash
# Створити віртуальне середовище
python3 -m venv venv

# Активувати віртуальне середовище
source venv/bin/activate
```

**Примітка:** Якщо на Windows виникає помилка "execution of scripts is disabled", виконайте в PowerShell від імені адміністратора:
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### Крок 2: Встановлення залежностей

Після активації віртуального середовища встановіть залежності:
```bash
pip install -r requirements.txt
```

**Примітка:** Після активації віртуального середовища ви побачите `(venv)` перед рядком команди в терміналі.

## Запуск

Запустіть сервер:
```bash
uvicorn main:app --reload
```

Сервер буде доступний за адресою: `http://localhost:8000`

## Використання

### Endpoint `/`

Головна сторінка з формою для введення slug або URL. Відкривається за адресою `http://localhost:8000/`

### Endpoint `/analyze`

Аналізує історичні дані спреду та знаходить точки сходження. Може повертати JSON або HTML з інтерактивною діаграмою.

**Параметри:**
- `url` (обов'язковий) - повний URL або slug для завантаження даних
- `limit` (опціональний, за замовчуванням 1500) - кількість точок для аналізу
- `tolerance` (опціональний, за замовчуванням 0.01) - толерантність для визначення сходження
- `format` (опціональний, за замовчуванням `json`) - формат відповіді: `json` або `html`
- `avg_method` (опціональний, за замовчуванням `methods`) - метод розрахунку середнього:
  - `simple` - просте середнє арифметичне всіх значень out
  - `methods` - середнє з результатів різних методик аналізу
  - `both` - комбіноване середнє (методики + просте середнє)
- `use_histogram` (опціональний) - використовувати гістограму для аналізу (`true`/`false`)
- `use_mode` (опціональний) - використовувати моду для аналізу (`true`/`false`)
- `use_kde` (опціональний) - використовувати KDE (Kernel Density Estimation) для аналізу (`true`/`false`)
- `use_clustering` (опціональний) - використовувати кластеризацію для аналізу (`true`/`false`)
- `use_quantiles` (опціональний) - використовувати квантилі (медіану) для аналізу (`true`/`false`)

### Endpoint `/api`

Повертає інформацію про доступні endpoints API.

**Приклади:**

1. **Отримати JSON з результатами аналізу:**
```
http://localhost:8000/analyze?url=sqd-mexc-swap-gate-swap&limit=1500&tolerance=0.01
```
або явно вказати формат:
```
http://localhost:8000/analyze?url=sqd-mexc-swap-gate-swap&limit=1500&format=json
```

2. **Отримати інтерактивну діаграму (HTML):**
```
http://localhost:8000/analyze?url=sqd-mexc-swap-gate-swap&limit=1500&format=html
```

3. **З повним URL:**
```
http://localhost:8000/analyze?url=https://uainvest.com.ua/api/arbitrage/historical?slug=sqd-mexc-swap-gate-swap&limit=1500&format=html
```

**Результат:**
- **JSON формат** (`format=json` або без параметра):
  - Виводить результати в консоль сервера
  - Повертає JSON відповідь з результатами аналізу
  - Додаткові поля для аналізу `in` та перевірок за часовими вікнами:
    - `in_analysis` — результати методик для `in` (гістограма/мода/KDE/кластеризація/квантилі)
    - `average_in_from_methods` — середнє значення для `in` (залежно від `avg_method` і вибраних методик)
    - `simple_mean_in` — просте середнє для `in`
    - `lookback_checks` — статистика та перевірки для `in`/`out` за останні 2/4/8/16 год
    - `convergence_statistics_in` / `convergence_statistics_out` — min/max/avg у точках сходження окремо для `in` та `out` (поле `convergence_statistics` лишається для сумісності)
  
- **HTML формат** (`format=html`):
  - Повертає HTML сторінку з інтерактивною діаграмою Plotly
  - Показує дві лінії: In (зелена) та Out (червона)
  - Відображає поточні значення та статус бірж
  - Дозволяє зум, наведення курсора та інші інтерактивні функції

### Візуалізація

Діаграма відображає:
- **Лінія In** (зелена) - значення `in_` з кожної точки спреду
- **Лінія Out** (червона) - значення `out` з кожної точки спреду
- **Поточні значення** - показуються у вигляді пунктирних ліній та окремих блоків
- **Статус бірж** - індикатори онлайн/офлайн статусу
- **Результати аналізу** — окремо для `In` та `Out`:
  - Найчастішого діапазону (гістограма)
  - Моди (найчастіше значення)
  - Піків KDE (найвищі значення щільності)
  - Центрів кластерів
  - Медіани та квантилів
  - Загального середнього значення
- **Lookback перевірка (2/4/8/16 год)** — min/max/avg та прапорці:
  - `crossed 0` — чи перетинав/торкався 0
  - `|x| ≤ 0.5` / `|x| ≤ 1.0` — чи було значення близько до 0 в межах порогу
- **Інтерактивність** - зум, панорама, наведення курсора для перегляду точних значень
- **Налаштування** - панель для зміни параметрів аналізу з можливістю оновлення графіка без перезавантаження сторінки

## Структура проекту

```
UA-history/
├── main.py              # Точка входу FastAPI додатку
├── services/
│   └── spread_analyzer.py  # Логіка аналізу спреду та підготовка даних для графіка
├── models/
│   └── schemas.py       # Pydantic моделі для даних
├── templates/
│   └── chart.html       # HTML шаблон з інтерактивною діаграмою Plotly
├── requirements.txt     # Залежності
└── README.md           # Документація
```

## Алгоритм роботи

1. Завантажує історичні дані спреду з API (`https://uainvest.com.ua/api/arbitrage/historical`)
2. Знаходить точки сходження (де `abs(in - out) <= tolerance`)
3. Рахує найчастіше значення спреду в точках сходження
4. Виконує аналіз найчастіших значень через різні методики:
   - **Гістограма** - знаходить найчастіший діапазон значень через бінінг
   - **Мода** - знаходить найчастіше точне значення
   - **KDE** - Kernel Density Estimation для виявлення піків щільності розподілу
   - **Кластеризація** - K-means або DBSCAN для групування схожих значень
   - **Квантилі** - обчислює медіану, Q1, Q3 та інтерквартильний діапазон
5. Обчислює середнє значення з вибраних методик (або просте середнє арифметичне) **окремо для `in` та `out`**
6. Рахує **lookback** статистику (min/max/avg) і перевірки “перетин 0/пороги” за останні 2/4/8/16 годин **для `in` та `out`**
7. Виводить статистику в консоль
8. При `format=html`: підготовлює дані та рендерить інтерактивну діаграму з усіма результатами аналізу

## Швидкий старт

1. **Створіть та активуйте віртуальне середовище:**

Windows (PowerShell):
```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1
```

Windows (Command Prompt):
```cmd
python -m venv venv
venv\Scripts\activate.bat
```

Linux/Mac:
```bash
python3 -m venv venv
source venv/bin/activate
```

2. **Встановіть залежності:**
```bash
pip install -r requirements.txt
```

3. **Запустіть сервер:**
```bash
uvicorn main:app --reload
```

4. **Відкрийте браузер та перейдіть за адресою:**
```
http://localhost:8000/analyze?url=sqd-mexc-swap-gate-swap&limit=1500&format=html
```

Або просто відкрийте головну сторінку:
```
http://localhost:8000
```

Ви побачите інтерактивну діаграму з історичними даними спреду!

**Примітка:** Для деактивації віртуального середовища виконайте команду `deactivate` в терміналі.

## Що робить проект

Цей проект є інструментом для аналізу історичних даних спреду між криптовалютними біржами. Він допомагає:

1. **Знаходити точки сходження** - моменти, коли значення `in` та `out` спреду стають дуже близькими (з урахуванням толерантності)
2. **Визначати найчастіші значення спреду** - використовуючи різні статистичні методики
3. **Візуалізувати дані** - через інтерактивні графіки з можливістю аналізу різних аспектів розподілу
4. **Обчислювати середні значення** - комбінуючи результати різних методик аналізу для більш точного визначення типового значення спреду

## Функціонал

### Основні можливості:
- ✅ Завантаження історичних даних з API
- ✅ Пошук точок сходження спреду
- ✅ Статистичний аналіз через 5 різних методик:
  - Гістограма з автоматичним визначенням бінів
  - Мода (найчастіше значення)
  - KDE (оцінка щільності розподілу)
  - Кластеризація (K-means або DBSCAN)
  - Квантилі та медіана
- ✅ Обчислення середнього значення з вибраних методик
- ✅ Інтерактивна візуалізація з Plotly
- ✅ Веб-інтерфейс з формою для введення даних
- ✅ Налаштування параметрів аналізу через веб-інтерфейс
- ✅ Оновлення графіка без перезавантаження сторінки (AJAX)
- ✅ Експорт графіків у формат PNG

### API Endpoints:
- `GET /` - головна сторінка з формою
- `GET /analyze` - аналіз спреду з параметрами
- `GET /api` - інформація про API

## Ризики та обмеження

### Ризики:
1. **Залежність від зовнішнього API** - проект залежить від доступності API `uainvest.com.ua`. Якщо API недоступний або змінить формат відповіді, проект перестане працювати.
2. **Обмеження кількості даних** - за замовчуванням завантажується максимум 1500 точок (можна змінити через параметр `limit`, але API може мати свої обмеження).
3. **Точність аналізу** - результати залежать від якості вхідних даних та правильності вибору параметрів (толерантність, кількість кластерів тощо).
4. **Продуктивність** - при великій кількості точок (>10000) обчислення можуть займати значний час, особливо кластеризація та KDE.

### Обмеження:
1. **Статичні дані** - проект працює з історичними даними, не надає реального часу.
2. **Обмежена підтримка бірж** - автоматичне визначення назв бірж працює тільки для: MEXC, Gate, Binance, OKX, Bybit.
3. **Відсутність автентифікації** - немає захисту endpoints, будь-хто може використовувати API.
4. **Відсутність кешування** - кожен запит виконує повне завантаження та обчислення даних.
5. **Обмежена обробка помилок** - базова обробка помилок, може потребувати покращення для продакшн використання.
6. **Відсутність валідації даних** - не перевіряється коректність даних з API перед обробкою.

### Рекомендації для покращення:
- Додати кешування результатів
- Реалізувати обробку помилок API
- Додати валідацію вхідних параметрів
- Додати логування для діагностики
- Реалізувати обмеження швидкості запитів (rate limiting)
- Додати підтримку інших бірж
- Оптимізувати алгоритми для великих обсягів даних
